# vim: set ft=sh sw=2 ts=8 et :
deploy_t0_reqmon_deps()
{
  deploy $stage couchdb
  deploy $stage bigcouch
}

deploy_t0_reqmon_prep()
{
  mkproj
}

deploy_t0_reqmon_sw()
{
  deploy_pkg comp cms+t0_reqmon
  perl -p -i -e 's/__fill_dbname_here__/tier0_wmstats/g' $root/$cfgversion/apps.$glabel/t0_reqmon/data/couchapps/WMStats/_attachments/js/loader.js
}

deploy_t0_reqmon_post()
{
  # Tell couch to push the t0_reqmon app on the next restart
  for couch in couchdb:5984 bigcouch:5985; do
    echo "couchapp push $root/$cfgversion/apps.$glabel/t0_reqmon/data/couchapps/WMStats" \
         "http://localhost:${couch##*:}/tier0_wmstats" > $root/state/${couch%%:*}/stagingarea/t0_reqmon
    echo "couchapp push $root/$cfgversion/apps.$glabel/t0_reqmon/data/couchapps/T0Request" \
         "http://localhost:${couch##*:}/t0_request" >> $root/state/${couch%%:*}/stagingarea/t0_reqmon
    echo "couchapp push $root/$cfgversion/apps.$glabel/t0_reqmon/data/couchapps/WorkloadSummary" \
         "http://localhost:${couch##*:}/t0_workloadsummary" >> $root/state/${couch%%:*}/stagingarea/t0_reqmon
    echo "couchapp push $root/$cfgversion/apps.$glabel/reqmon/data/couchapps/LogDB" \
         "http://localhost:${couch##*:}/t0_logdb" >> $root/state/${couch%%:*}/stagingarea/reqmon
  done
}
