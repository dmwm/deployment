# vim: set ft=sh sw=2 ts=8 et :

# default - deploy on CMSWEB
# replication branching - can replicate to just 1 target at once
# offsitedev - offsite (local WMAgent) and replicate on cmsweb-dev.cern.ch
# offsitepreprod - offsite (local WMAgent) and replicate to cmsweb-testbed.cern.ch
# offsiteprod - offsite (local WMAgent) and replicate to (prod) cmsweb.cern.ch
# offsitepriv - offsite (local WMAgent) and replicate to maxadmwm.cern.ch
deploy_alertscollector_variants="default offsitedev offsitepreprod offsiteprod offsitepriv"


deploy_alertscollector_deps()
{
  case $variant in
    offsitedev|offsitepreprod|offsiteprod|offsitepriv )
      # this is installation along with WMAgent. Couch is installed as WMAgent
      # dependency. Installing it here for (offsite* scenario) leads to couchdb
      # fails on curl http://`hostname`:5984/_all_dbs
      # (neither deploy couchdb default or offsite works here)
      # also not installing it at all (i.e. leaving this block empty) does not
      # work for the deployment fails down here on couchapp push
      # Have to figure out with Diego how alertscollector can be installed
      # the HTTPGroup-advisable way along with WMAgent ...
      ;;
    default )
      deploy couchdb default
      ;;
  esac
}

deploy_alertscollector_prep()
{
  mkproj
}

deploy_alertscollector_sw()
{
  deploy_pkg comp cms+alertscollector
}

setup_replication()
{
  # $1 - target or replication
  enable
  (echo {,$1/couchdb/}alertscollector AlertsCollector/repfilter
  echo {$1/couchdb/,}alertscollector AlertsCollector/repfilter
  ) > $root/state/couchdb/replication/alertscollector
}

deploy_alertscollector_post()
{
  # Tell couchdb to push the AlertsCollector couchapp on the next restart
  echo "couchapp push $root/current/apps/alertscollector/data/couchapps/AlertsCollector" \
       "http://localhost:5984/alertscollector" > $root/state/couchdb/stagingarea/alertscollector

  # Set up database replication if deploying with local WMAgent CouchDB
  case $variant in
    offsitedev )
      setup_replication "https://cmsweb-dev.cern.ch"
      ;;
    offsitepreprod )
      setup_replication "https://cmsweb-testbed.cern.ch"
      ;;
    offsiteprod )
      setup_replication "https://cmsweb.cern.ch"
      ;;
    offsitepriv )
      setup_replication "https://maxadmwm.cern.ch"
      ;;
  esac
}
