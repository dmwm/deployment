# vim: set ft=sh sw=2 ts=8 et :
deploy_das_deps()
{
  deploy backend
  deploy wmcore-auth
  deploy mongodb
  deploy admin
}

deploy_das_prep()
{
  mkproj
  mkproxy
}

deploy_das_sw()
{
  deploy_pkg comp cms+das
  perl -p -i -e "s|{ROOT}|$root|" $project_config/analytics_cfg.py
}

deploy_das_post()
{
  case $host in vocms34 | vocms13[2689] | vocms16[13] ) disable ;; * ) enable ;; esac

  local cmd_fetch="sudo -H -u _das bashs -l -c '$project_config/manage fetchdata_silent'"
  local cmd_update="sudo -H -u _das bashs -l -c '$project_config/manage updatedata_silent'"

  # make sure  staging dir exists with right permissions
  local mongodb_stage="$root/state/das/mongodb_staging"
  mkdir -p "$mongodb_stage"
  sudo chown -Rf _das:_das "$mongodb_stage"

  (
   mkcrontab; sysboot;
   if [ -f /data/enabled/das ]; then
     echo "*/2 0-23 * * * ${cmd_update}"    # try to connect to mongodb and push any waiting updates
     echo "0 0-23 * * * ${cmd_fetch}"       # check if new update exists
   fi
  ) | crontab -
  
  sudo -H -u _das bashs -l -c "$project_config/manage resetdata_silent"  # this will stage the update
}
